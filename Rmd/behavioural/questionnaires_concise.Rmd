---
title: "questionnaires_concise"
author: "Aamir Sohail"
date: "2025-01-17"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, cache=TRUE}
# Install packages only if they are not already installed
required_packages <- c("ggplot2", "tidyverse", "ggpubr", "rstatix", "ez", "lme4", "lmerTest", "car", "emmeans", "MuMIn", "psych", "interactions", "effects", "here", "lm.beta", "effectsize", "parallel")
install_if_missing <- required_packages[!required_packages %in% installed.packages()]
if (length(install_if_missing) > 0) {
  install.packages(install_if_missing, quietly = TRUE)
}

# Load libraries
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(rstatix)
library(ez)
library(lme4)
library(car)
library(readr)
library(lmerTest)
library(emmeans)
library(MuMIn)
library(corrplot)
library(reshape2)
library(psych)
library(interactions)
library(effects)
library(here)
library(conflicted)
library(lm.beta)
library(effectsize)
library(parallel)

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflicts_prefer(lmerTest::lmer)
conflicts_prefer(effectsize::eta_squared)
```

## Within-trial choice switch probability and bet difference by group consensus and direction

```{r setup, include=FALSE, message=FALSE}
rm(list=ls())

# Source the core pipeline functions
source(here("R", "questionnaire_mixed_models.R"))

################## SPECIFIC PREPROCESSING ###################
preprocess_consensus_data <- function(data, outcome_type, questionnaire_var, group_2_2_in_with = FALSE, params) {
  print(paste("Processing questionnaire:", questionnaire_var))
  print(paste("Initial number of unique participants:", length(unique(data$participant.id_in_session))))
  
  # Get subscales for the current questionnaire
  subscales <- params$subscale_mapping[[questionnaire_var]]
  
  base_data <- data %>%
    mutate(
      consensus_level = case_when(
        player.choice1_with %in% c(0, 1) ~ "4:0",
        player.choice1_with %in% c(0.25, 0.75) ~ "3:1",
        player.choice1_with == 0.5 ~ "2:2"
      ),
      direction = if_else(player.choice1_with >= 0.5, "With group", "Against group"),
      consensus_level = factor(consensus_level, levels = c("2:2", "3:1", "4:0")),
      direction = factor(direction, levels = c("Against group", "With group"))
    )

  # Process outcome variable
  outcome_data <- if(outcome_type == "switch") {
    base_data %>%
      group_by(participant.id_in_session, consensus_level, direction, gender) %>%
      summarise(
        outcome_value = mean(player.switch_vs_stay) * 100,
        .groups = 'drop'
      )
  } else {
    base_data %>%
      mutate(bet_difference = player.bet2 - player.bet1) %>%
      group_by(participant.id_in_session, consensus_level, direction, gender) %>%
      summarise(
        outcome_value = mean(bet_difference),
        .groups = 'drop'
      )
  }

  # Join with questionnaire data 
  joined_data <- outcome_data %>%
    left_join(
      base_data %>%
        group_by(participant.id_in_session) %>%
        slice(1) %>%
        select(participant.id_in_session, 
               !!questionnaire_var, 
               age,
               !!!syms(subscales)),
      by = "participant.id_in_session"
    )
  
  # Scale main variables and subscales consistently
  scaled_data <- joined_data %>%
    mutate(
      scale_name = as.numeric(scale(.data[[questionnaire_var]])),
      age = as.numeric(scale(age)),
      gender = factor(gender)
    )

  # Scale subscales if they exist - now using the same standardization approach
  if (!is.null(subscales)) {
    for (subscale in subscales) {
      scaled_data[[subscale]] <- as.numeric(scale(scaled_data[[subscale]]))
    }
  }

  return(scaled_data)
}

################## MODEL FORMULAS ###################
consensus_model_formulas <- list(
  m1 = list(
    formula = outcome_value ~ consensus_level + direction + scale_name + 
              age + (1|participant.id_in_session),
    description = "Main effects only"
  ),
  m2 = list(
    formula = outcome_value ~ (consensus_level + direction + scale_name)^2 + 
              age + (1|participant.id_in_session),
    description = "Two-way interactions"
  ),
  m3 = list(
    formula = outcome_value ~ consensus_level * direction * scale_name + 
              age + (1|participant.id_in_session),
    description = "Three-way interaction"
  ),
  m4 = list(
    formula = outcome_value ~ consensus_level * direction * scale_name + 
              age + (1 + consensus_level|participant.id_in_session),
    description = "Three-way with random slope"
  ),
  m5 = list(
    formula = outcome_value ~ consensus_level * direction * scale_name + 
              age + (1 + consensus_level|participant.id_in_session) + (1|gender),
    description = "Full model with gender"
  )
)

# Define parameters for switch analysis
switch_params <- list(
  analysis_type = "choice_consensus",
  preprocessing_fn = function(data, var) {
    preprocess_consensus_data(data, "switch", var, FALSE, switch_params)
  },
  model_formulas = consensus_model_formulas,
  questionnaire_vars = c("ssms", "dass", "lsas", "srp_sf", "ami", "aq_10"),
  analysis_name = "Choice Switch by Group Consensus",
  y_label = "Choice switch probability (%)",
  is_percentage = TRUE,
  subscale_mapping = list(
    lsas = c("lsas_p", "lsas_s"),
    dass = c("dass_a", "dass_d", "dass_s"),
    ssms = c("ssms_cd", "ssms_ia"),
    srp_sf = c("srp_sf_ipm", "srp_sf_ca", "srp_sf_els", "srp_sf_ct"),
    ami = c("ami_es", "ami_sm", "ami_ba"),
    aq_10 = NULL
  )
)

# Define parameters for bet analysis
bet_params <- list(
  analysis_type = "choice_consensus",
  preprocessing_fn = function(data, var) {
    preprocess_consensus_data(data, "bet", var, FALSE, bet_params)
  },
  model_formulas = consensus_model_formulas,
  questionnaire_vars = c("ssms", "dass", "lsas", "srp_sf", "ami", "aq_10"),
  analysis_name = "Bet Difference by Group Consensus",
  y_label = "Bet difference (Bet 2 - Bet 1)",
  is_percentage = FALSE,
  subscale_mapping = list(
    lsas = c("lsas_p", "lsas_s"),
    dass = c("dass_a", "dass_d", "dass_s"),
    ssms = c("ssms_cd", "ssms_ia"),
    srp_sf = c("srp_sf_ipm", "srp_sf_ca", "srp_sf_els", "srp_sf_ct"),
    ami = c("ami_es", "ami_sm", "ami_ba"),
    aq_10 = NULL
  )
)

################## RUN ANALYSES AND SAVE OUTPUT ###################
# Read data
data <- read_csv(here("data", "preprocessed", "merged_test_data.csv"), 
                 show_col_types = FALSE)

# Define directory structure
questionnaire_dir <- here("output", "behav", "questionnaire")
analysis_dir <- file.path(questionnaire_dir, "ch_switch_and_bet_mag_by_consensus")

# Create main output directories for plots and txt
plot_base_dir <- file.path(analysis_dir, "plots")
txt_base_dir <- file.path(analysis_dir, "txt")

# Create txt directory
dir.create(txt_base_dir, recursive = TRUE, showWarnings = FALSE)

# Run switch analysis
switch_results <- run_model_pipeline(
  data = data,
  params = switch_params,
  output_path = file.path(txt_base_dir, "choice_switching_by_group_consensus.txt")
)

# Run bet analysis
bet_results <- run_model_pipeline(
  data = data,
  params = bet_params,
  output_path = file.path(txt_base_dir, "bet_difference_by_group_consensus.txt")
)

# Save plots for both analyses
save_analysis_plots(switch_results, "choice_switch", analysis_dir)
save_analysis_plots(bet_results, "bet_magnitude", analysis_dir)
```

## Choice accuracy and bet magnitude as a function of switch difference across trials (Choice 2 - Choice 1), by group consensus and direction

```{r setup, include=FALSE, message=FALSE}
rm(list=ls())

# Source the core pipeline functions
source(here("R", "questionnaire_mixed_models.R"))

################## SPECIFIC PREPROCESSING ###################
preprocess_switch_diff_data <- function(data, outcome_type, questionnaire_var, params) {
  # Get subscales for the current questionnaire
  subscales <- params$subscale_mapping[[questionnaire_var]]
  
  # Create base transformations
  base_data <- data %>%
    filter(!is.na(choice_switch_across_trials)) %>%
    mutate(
      # Keep original binary coding without standardization
      switch_difference = choice_switch_across_trials,  # Just 0 or 1
      # Create trial_type factor from original values
      trial_type = factor(if_else(choice_switch_across_trials == 0, "Stay", "Switch"), 
                         levels = c("Stay", "Switch")),
      consensus_level = case_when(
        player.choice1_with %in% c(0, 1) ~ "4:0",
        player.choice1_with %in% c(0.25, 0.75) ~ "3:1",
        player.choice1_with == 0.5 ~ "2:2"
      ),
      direction = if_else(player.choice1_with >= 0.5, "With group", "Against group"),
      consensus_level = factor(consensus_level, levels = c("2:2", "3:1", "4:0")),
      direction = factor(direction, levels = c("Against group", "With group"))
    )

  # Process outcome variable based on type
  outcome_data <- if(outcome_type == "accuracy") {
    base_data %>%
      group_by(participant.id_in_session, consensus_level, direction, switch_difference, trial_type, gender) %>%
      summarise(
        outcome_value = mean(player.choice1_accuracy) * 100,
        .groups = 'drop'
      )
  } else {  # bet magnitude
    base_data %>%
      group_by(participant.id_in_session, consensus_level, direction, switch_difference, trial_type, gender) %>%
      summarise(
        outcome_value = mean(player.bet1),
        .groups = 'drop'
      )
  }

  # Join with questionnaire data and scale other variables
  scaled_data <- outcome_data %>%
    left_join(
      base_data %>%
        group_by(participant.id_in_session) %>%
        slice(1) %>%
        select(participant.id_in_session, 
               !!questionnaire_var, 
               age,
               !!!syms(subscales)),
      by = "participant.id_in_session"
    ) %>%
    mutate(
      scale_name = as.numeric(scale(.data[[questionnaire_var]])),
      age = as.numeric(scale(age)),
      gender = factor(gender)
    )

  # Scale subscales if they exist
  if (!is.null(subscales)) {
    for (subscale in subscales) {
      scaled_data[[subscale]] <- as.numeric(scale(scaled_data[[subscale]]))
    }
  }

  return(scaled_data)
}

################## MODEL FORMULAS ###################
switch_diff_model_formulas <- list(
  m1 = list(
    formula = outcome_value ~ consensus_level + direction + switch_difference + scale_name + 
              age + (1|participant.id_in_session),
    description = "Main effects only"
  ),
  m2 = list(
    formula = outcome_value ~ (consensus_level + direction + switch_difference + scale_name)^2 + 
              age + (1|participant.id_in_session),
    description = "Two-way interactions"
  ),
  m3 = list(
    formula = outcome_value ~ consensus_level * direction * switch_difference * scale_name + 
              age + (1|participant.id_in_session),
    description = "Three-way interaction"
  ),
  m4 = list(
    formula = outcome_value ~ consensus_level * direction * switch_difference * scale_name + 
              age + (1 + switch_difference|participant.id_in_session),
    description = "Three-way with random slope for switch difference"
  ),
  m5 = list(
    formula = outcome_value ~ consensus_level * direction * switch_difference * scale_name + 
              age + (1 + switch_difference|participant.id_in_session) + (1|gender),
    description = "Full model with gender"
  )
)

# Define parameters for accuracy analysis
accuracy_params <- list(
  analysis_type = "switch_difference",
  preprocessing_fn = function(data, var) {
    preprocess_switch_diff_data(data, "accuracy", var, accuracy_params)
  },
  model_formulas = switch_diff_model_formulas,
  questionnaire_vars = c("ssms", "dass", "lsas", "srp_sf", "ami", "aq_10"),
  analysis_name = "Choice Accuracy by Switch Difference",
  y_label = "Choice accuracy (%)",
  is_percentage = TRUE,
  subscale_mapping = list(
    lsas = c("lsas_p", "lsas_s"),
    dass = c("dass_a", "dass_d", "dass_s"),
    ssms = c("ssms_cd", "ssms_ia"),
    srp_sf = c("srp_sf_ipm", "srp_sf_ca", "srp_sf_els", "srp_sf_ct"),
    ami = c("ami_es", "ami_sm", "ami_ba"),
    aq_10 = NULL
  )
)

# Define parameters for bet analysis
bet_params <- list(
  analysis_type = "switch_difference",
  preprocessing_fn = function(data, var) {
    preprocess_switch_diff_data(data, "bet", var, bet_params)
  },
  model_formulas = switch_diff_model_formulas,
  questionnaire_vars = c("ssms", "dass", "lsas", "srp_sf", "ami", "aq_10"),
  analysis_name = "Bet Magnitude by Switch Difference",
  y_label = "Bet magnitude",
  is_percentage = FALSE,
  subscale_mapping = list(
    lsas = c("lsas_p", "lsas_s"),
    dass = c("dass_a", "dass_d", "dass_s"),
    ssms = c("ssms_cd", "ssms_ia"),
    srp_sf = c("srp_sf_ipm", "srp_sf_ca", "srp_sf_els", "srp_sf_ct"),
    ami = c("ami_es", "ami_sm", "ami_ba"),
    aq_10 = NULL
  )
)

################## RUN ANALYSES AND SAVE OUTPUT ####################
# Read data
data <- read_csv(here("data", "preprocessed", "merged_test_data.csv"), 
                 show_col_types = FALSE)

# Define directory structure
questionnaire_dir <- here("output", "behav", "questionnaire")
analysis_dir <- file.path(questionnaire_dir, "choice_acc_and_bet_mag_by_switch_across_trials")

# Create main output directories for plots and txt
plot_base_dir <- file.path(analysis_dir, "plots")
txt_base_dir <- file.path(analysis_dir, "txt")

# Create txt directory
dir.create(txt_base_dir, recursive = TRUE, showWarnings = FALSE)

# Run accuracy analysis
accuracy_results <- run_model_pipeline(
  data = data,
  params = accuracy_params,
  output_path = file.path(txt_base_dir, "choice_accuracy_by_switch_difference.txt")
)

# Run bet analysis
bet_results <- run_model_pipeline(
  data = data,
  params = bet_params,
  output_path = file.path(txt_base_dir, "bet_magnitude_by_switch_difference.txt")
)

# Save plots for both analyses
save_analysis_plots(accuracy_results, "choice_accuracy", analysis_dir)
save_analysis_plots(bet_results, "bet_magnitude", analysis_dir)
```
