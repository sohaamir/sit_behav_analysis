---
title: "switch_difference_analysis"
output: html_document
---

## Choice accuracy and bet magnitude as a function of switch difference across trials (Choice 2 - Choice 1) and group consensus

```{r, include=FALSE, message=FALSE}

rm(list=ls())

# Source the core pipeline functions
source(here("R", "questionnaire_mixed_models.R"))

################## SPECIFIC PREPROCESSING ###################
preprocess_switch_diff_data <- function(data, outcome_type, questionnaire_var, params) {
  print(paste("Processing questionnaire:", questionnaire_var))
  print(paste("Number of rows in input data:", nrow(data)))
  
  # Get subscales for the current questionnaire
  subscales <- params$subscale_mapping[[questionnaire_var]]
  
  # Create base transformations
  base_data <- data %>%
    mutate(
      switch_difference = player.choice2 - player.choice1,
      consensus_level = case_when(
        player.choice1_with %in% c(0, 1) ~ "4:0",
        player.choice1_with %in% c(0.25, 0.75) ~ "3:1",
        player.choice1_with == 0.5 ~ "2:2"
      ),
      direction = if_else(player.choice1_with >= 0.5, "With group", "Against group"),
      consensus_level = factor(consensus_level, levels = c("2:2", "3:1", "4:0")),
      direction = factor(direction, levels = c("Against group", "With group"))
    )

  # Process outcome variable based on type
  if(outcome_type == "accuracy") {
    outcome_data <- base_data %>%
      group_by(participant.id_in_session, consensus_level, direction, switch_difference, gender) %>%
      summarise(
        outcome_value = mean(player.choice1_accuracy) * 100,
        .groups = 'drop'
      )
  } else {  # bet magnitude
    outcome_data <- base_data %>%
      group_by(participant.id_in_session, consensus_level, direction, switch_difference, gender) %>%
      summarise(
        outcome_value = mean(player.bet1),
        .groups = 'drop'
      )
  }

  # Join with questionnaire data and scale variables
  joined_data <- outcome_data %>%
    left_join(
      base_data %>%
        group_by(participant.id_in_session) %>%
        slice(1) %>%
        select(participant.id_in_session, 
               !!questionnaire_var, 
               age,
               !!!syms(subscales)),
      by = "participant.id_in_session"
    )
  
  # Scale variables
  scaled_data <- joined_data %>%
    mutate(
      scale_name = as.numeric(scale(.data[[questionnaire_var]])),
      age = as.numeric(scale(age)),
      switch_difference = as.numeric(scale(switch_difference)),
      gender = factor(gender)
    )
  
  # Scale subscales if they exist
  if (!is.null(subscales)) {
    for (subscale in subscales) {
      scaled_data[[subscale]] <- scale(scaled_data[[subscale]])
    }
  }
  
  print(paste("Number of rows in output data:", nrow(scaled_data)))
  print(paste("Columns in output data:", paste(colnames(scaled_data), collapse=", ")))
  
  return(scaled_data)
}

################## MODEL FORMULAS ###################
switch_diff_model_formulas <- list(
  m1 = list(
    formula = outcome_value ~ consensus_level + direction + switch_difference + scale_name + 
              age + (1|participant.id_in_session),
    description = "Main effects only"
  ),
  m2 = list(
    formula = outcome_value ~ (consensus_level + direction + switch_difference + scale_name)^2 + 
              age + (1|participant.id_in_session),
    description = "Two-way interactions"
  ),
  m3 = list(
    formula = outcome_value ~ consensus_level * direction * switch_difference * scale_name + 
              age + (1|participant.id_in_session),
    description = "Three-way interaction"
  ),
  m4 = list(
    formula = outcome_value ~ consensus_level * direction * switch_difference * scale_name + 
              age + (1 + switch_difference|participant.id_in_session),
    description = "Three-way with random slope for switch difference"
  ),
  m5 = list(
    formula = outcome_value ~ consensus_level * direction * switch_difference * scale_name + 
              age + (1 + switch_difference|participant.id_in_session) + (1|gender),
    description = "Full model with gender"
  )
)

# Define parameters for accuracy analysis
accuracy_params <- list(
  analysis_type = "switch_difference",
  preprocessing_fn = function(data, var) {
    preprocess_switch_diff_data(data, "accuracy", var, accuracy_params)
  },
  model_formulas = switch_diff_model_formulas,
  questionnaire_vars = c("ssms", "dass", "lsas", "srp_sf", "ami", "aq_10"),
  analysis_name = "Choice Accuracy by Switch Difference",
  y_label = "Choice accuracy (%)",
  is_percentage = TRUE,
  subscale_mapping = list(
    lsas = c("lsas_p", "lsas_s"),
    dass = c("dass_a", "dass_d", "dass_s"),
    ssms = c("ssms_cd", "ssms_ia"),
    srp_sf = c("srp_sf_ipm", "srp_sf_ca", "srp_sf_els", "srp_sf_ct"),
    ami = c("ami_es", "ami_sm", "ami_ba"),
    aq_10 = NULL
  )
)

# Define parameters for bet analysis
bet_params <- list(
  analysis_type = "switch_difference",
  preprocessing_fn = function(data, var) {
    preprocess_switch_diff_data(data, "bet", var, bet_params)
  },
  model_formulas = switch_diff_model_formulas,
  questionnaire_vars = c("ssms", "dass", "lsas", "srp_sf", "ami", "aq_10"),
  analysis_name = "Bet Magnitude by Switch Difference",
  y_label = "Bet magnitude",
  is_percentage = FALSE,
  subscale_mapping = list(
    lsas = c("lsas_p", "lsas_s"),
    dass = c("dass_a", "dass_d", "dass_s"),
    ssms = c("ssms_cd", "ssms_ia"),
    srp_sf = c("srp_sf_ipm", "srp_sf_ca", "srp_sf_els", "srp_sf_ct"),
    ami = c("ami_es", "ami_sm", "ami_ba"),
    aq_10 = NULL
  )
)

################## RUN ANALYSES AND SAVE OUTPUT ###################
# Read data
data <- read_csv(here("data", "preprocessed", "merged_test_data.csv"), 
                 show_col_types = FALSE)

# Define analysis-specific base directory name
base_dir <- "choice_acc_and_bet_mag_by_switch_across_trials"

# Create main output directories
plot_base_dir <- here("output", "behav", "questionnaire", "plots", base_dir)
txt_base_dir <- here("output", "behav", "questionnaire", "txt", base_dir)

# Create analysis-specific directories for plots
for(analysis in ANALYSIS_TYPES) {
  for(plot_type in PLOT_TYPES) {
    dir.create(file.path(plot_base_dir, analysis, plot_type), 
               recursive = TRUE, 
               showWarnings = FALSE)
  }
}

# Create txt directory
dir.create(txt_base_dir, recursive = TRUE, showWarnings = FALSE)

# Run accuracy analysis
accuracy_results <- run_model_pipeline(
  data = data,
  params = accuracy_params,
  output_path = file.path(txt_base_dir, "choice_accuracy_by_switch_difference.txt")
)

# Run bet analysis
bet_results <- run_model_pipeline(
  data = data,
  params = bet_params,
  output_path = file.path(txt_base_dir, "bet_magnitude_by_switch_difference.txt")
)

# Save plots for both analyses
save_analysis_plots(accuracy_results, "choice_accuracy", plot_base_dir)
save_analysis_plots(bet_results, "bet_magnitude", plot_base_dir)
```