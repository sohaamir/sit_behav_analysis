"0","rm(list=ls())"
"0",""
"0","# Source the core pipeline functions"
"0","source(here(""R"", ""questionnaire_mixed_models.R""))"
"0",""
"0","################## SPECIFIC PREPROCESSING ###################"
"0","preprocess_consensus_data <- function(data, outcome_type, questionnaire_var, group_2_2_in_with = FALSE, params) {"
"0","  print(paste(""Processing questionnaire:"", questionnaire_var))"
"0","  print(paste(""Initial number of unique participants:"", length(unique(data$participant.id_in_session))))"
"0","  "
"0","  # Get subscales for the current questionnaire"
"0","  subscales <- params$subscale_mapping[[questionnaire_var]]"
"0","  "
"0","  base_data <- data %>%"
"0","    mutate("
"0","      consensus_level = case_when("
"0","        player.choice1_with %in% c(0, 1) ~ ""4:0"","
"0","        player.choice1_with %in% c(0.25, 0.75) ~ ""3:1"","
"0","        player.choice1_with == 0.5 ~ ""2:2"""
"0","      ),"
"0","      direction = if_else(player.choice1_with >= 0.5, ""With group"", ""Against group""),"
"0","      consensus_level = factor(consensus_level, levels = c(""2:2"", ""3:1"", ""4:0"")),"
"0","      direction = factor(direction, levels = c(""Against group"", ""With group""))"
"0","    )"
"0",""
"0","  # Process outcome variable"
"0","  outcome_data <- if(outcome_type == ""switch"") {"
"0","    base_data %>%"
"0","      group_by(participant.id_in_session, consensus_level, direction, gender) %>%"
"0","      summarise("
"0","        outcome_value = mean(player.switch_vs_stay) * 100,"
"0","        .groups = 'drop'"
"0","      )"
"0","  } else {"
"0","    base_data %>%"
"0","      mutate(bet_difference = player.bet2 - player.bet1) %>%"
"0","      group_by(participant.id_in_session, consensus_level, direction, gender) %>%"
"0","      summarise("
"0","        outcome_value = mean(bet_difference),"
"0","        .groups = 'drop'"
"0","      )"
"0","  }"
"0",""
"0","  # Join with questionnaire data "
"0","  joined_data <- outcome_data %>%"
"0","    left_join("
"0","      base_data %>%"
"0","        group_by(participant.id_in_session) %>%"
"0","        slice(1) %>%"
"0","        select(participant.id_in_session, "
"0","               !!questionnaire_var, "
"0","               age,"
"0","               !!!syms(subscales)),"
"0","      by = ""participant.id_in_session"""
"0","    )"
"0","  "
"0","  # Scale main variables and subscales consistently"
"0","  scaled_data <- joined_data %>%"
"0","    mutate("
"0","      scale_name = as.numeric(scale(.data[[questionnaire_var]])),"
"0","      age = as.numeric(scale(age)),"
"0","      gender = factor(gender)"
"0","    )"
"0",""
"0","  # Scale subscales if they exist - now using the same standardization approach"
"0","  if (!is.null(subscales)) {"
"0","    for (subscale in subscales) {"
"0","      scaled_data[[subscale]] <- as.numeric(scale(scaled_data[[subscale]]))"
"0","    }"
"0","  }"
"0",""
"0","  return(scaled_data)"
"0","}"
"0",""
"0","################## MODEL FORMULAS ###################"
"0","consensus_model_formulas <- list("
"0","  m1 = list("
"0","    formula = outcome_value ~ consensus_level + direction + scale_name + "
"0","              age + (1|participant.id_in_session),"
"0","    description = ""Main effects only"""
"0","  ),"
"0","  m2 = list("
"0","    formula = outcome_value ~ (consensus_level + direction + scale_name)^2 + "
"0","              age + (1|participant.id_in_session),"
"0","    description = ""Two-way interactions"""
"0","  ),"
"0","  m3 = list("
"0","    formula = outcome_value ~ consensus_level * direction * scale_name + "
"0","              age + (1|participant.id_in_session),"
"0","    description = ""Three-way interaction"""
"0","  ),"
"0","  m4 = list("
"0","    formula = outcome_value ~ consensus_level * direction * scale_name + "
"0","              age + (1 + consensus_level|participant.id_in_session),"
"0","    description = ""Three-way with random slope"""
"0","  ),"
"0","  m5 = list("
"0","    formula = outcome_value ~ consensus_level * direction * scale_name + "
"0","              age + (1 + consensus_level|participant.id_in_session) + (1|gender),"
"0","    description = ""Full model with gender"""
"0","  )"
"0",")"
"0",""
"0","# Define parameters for switch analysis"
"0","switch_params <- list("
"0","  analysis_type = ""choice_consensus"","
"0","  preprocessing_fn = function(data, var) {"
"0","    preprocess_consensus_data(data, ""switch"", var, FALSE, switch_params)"
"0","  },"
"0","  model_formulas = consensus_model_formulas,"
"0","  questionnaire_vars = c(""ssms"", ""dass"", ""lsas"", ""srp_sf"", ""ami"", ""aq_10""),"
"0","  analysis_name = ""Choice Switch by Group Consensus"","
"0","  y_label = ""Choice switch probability (%)"","
"0","  is_percentage = TRUE,"
"0","  subscale_mapping = list("
"0","    lsas = c(""lsas_p"", ""lsas_s""),"
"0","    dass = c(""dass_a"", ""dass_d"", ""dass_s""),"
"0","    ssms = c(""ssms_cd"", ""ssms_ia""),"
"0","    srp_sf = c(""srp_sf_ipm"", ""srp_sf_ca"", ""srp_sf_els"", ""srp_sf_ct""),"
"0","    ami = c(""ami_es"", ""ami_sm"", ""ami_ba""),"
"0","    aq_10 = NULL"
"0","  )"
"0",")"
"0",""
"0","# Define parameters for bet analysis"
"0","bet_params <- list("
"0","  analysis_type = ""choice_consensus"","
"0","  preprocessing_fn = function(data, var) {"
"0","    preprocess_consensus_data(data, ""bet"", var, FALSE, bet_params)"
"0","  },"
"0","  model_formulas = consensus_model_formulas,"
"0","  questionnaire_vars = c(""ssms"", ""dass"", ""lsas"", ""srp_sf"", ""ami"", ""aq_10""),"
"0","  analysis_name = ""Bet Difference by Group Consensus"","
"0","  y_label = ""Bet difference (Bet 2 - Bet 1)"","
"0","  is_percentage = FALSE,"
"0","  subscale_mapping = list("
"0","    lsas = c(""lsas_p"", ""lsas_s""),"
"0","    dass = c(""dass_a"", ""dass_d"", ""dass_s""),"
"0","    ssms = c(""ssms_cd"", ""ssms_ia""),"
"0","    srp_sf = c(""srp_sf_ipm"", ""srp_sf_ca"", ""srp_sf_els"", ""srp_sf_ct""),"
"0","    ami = c(""ami_es"", ""ami_sm"", ""ami_ba""),"
"0","    aq_10 = NULL"
"0","  )"
"0",")"
"0",""
"0","################## RUN ANALYSES AND SAVE OUTPUT ###################"
"0","# Read data"
"0","data <- read_csv(here(""data"", ""preprocessed"", ""merged_test_data.csv""), "
"0","                 show_col_types = FALSE)"
"0",""
"0","# Define directory structure"
"0","questionnaire_dir <- here(""output"", ""behav"", ""questionnaire"")"
"0","analysis_dir <- file.path(questionnaire_dir, ""ch_switch_and_bet_mag_by_consensus"")"
"0",""
"0","# Create main output directories for plots and txt"
"0","plot_base_dir <- file.path(analysis_dir, ""plots"")"
"0","txt_base_dir <- file.path(analysis_dir, ""txt"")"
"0",""
"0","# Create txt directory"
"0","dir.create(txt_base_dir, recursive = TRUE, showWarnings = FALSE)"
"0",""
"0","# Run switch analysis"
"0","switch_results <- run_model_pipeline("
"0","  data = data,"
"0","  params = switch_params,"
"0","  output_path = file.path(txt_base_dir, ""choice_switching_by_group_consensus.txt"")"
"0",")"
"1","
===== Running Model Selection =====
"
"1","[1]"
"1"," ""Processing questionnaire: ssms"""
"1","
"
"1","[1]"
"1"," ""Initial number of unique participants: 100"""
"1","
"
"1","[1]"
"1"," ""Processing questionnaire: dass"""
"1","
"
"1","[1]"
"1"," ""Initial number of unique participants: 100"""
"1","
"
"1","[1]"
"1"," ""Processing questionnaire: lsas"""
"1","
"
"1","[1]"
"1"," ""Initial number of unique participants: 100"""
"1","
"
"1","[1]"
"1"," ""Processing questionnaire: srp_sf"""
"1","
"
"1","[1]"
"1"," ""Initial number of unique participants: 100"""
"1","
"
"1","[1]"
"1"," ""Processing questionnaire: ami"""
"1","
"
"1","[1]"
"1"," ""Initial number of unique participants: 100"""
"1","
"
"1","[1]"
"1"," ""Processing questionnaire: aq_10"""
"1","
"
"1","[1]"
"1"," ""Initial number of unique participants: 100"""
"1","
"
