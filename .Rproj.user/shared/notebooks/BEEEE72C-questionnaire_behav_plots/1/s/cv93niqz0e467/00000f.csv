"0","# Read and process data"
"0","merged_data <- read_csv(here(""data"", ""preprocessed"", ""merged_test_data.csv""), show_col_types = FALSE)"
"0",""
"0","# Calculate bet difference and create initial data structure"
"0","processed_data <- merged_data %>%"
"0","  mutate("
"0","    bet_difference = player.bet2 - player.bet1,"
"0","    consensus_group = case_when("
"0","      player.choice1_with == 0.5 ~ ""2:2_against"",  # Group 2:2 into against condition"
"0","      player.choice1_with == 0 ~ ""4:0_against"","
"0","      player.choice1_with == 0.25 ~ ""3:1_against"","
"0","      player.choice1_with == 0.75 ~ ""3:1_with"","
"0","      player.choice1_with == 1 ~ ""4:0_with"""
"0","    ),"
"0","    consensus_level = case_when("
"0","      player.choice1_with %in% c(0, 1) ~ ""4:0"","
"0","      player.choice1_with %in% c(0.25, 0.75) ~ ""3:1"","
"0","      player.choice1_with == 0.5 ~ ""2:2"""
"0","    ),"
"0","    direction = if_else(player.choice1_with >= 0.5, ""With group"", ""Against group"")"
"0","  ) %>%"
"0","  group_by(participant.id_in_session, consensus_group, direction, gender) %>%"
"0","  summarise("
"0","    mean_bet_diff = mean(bet_difference),"
"0","    .groups = 'drop'"
"0","  ) %>%"
"0","  left_join("
"0","    merged_data %>%"
"0","      group_by(participant.id_in_session) %>%"
"0","      slice(1) %>%"
"0","      select(participant.id_in_session, ssms, dass, lsas, srp_sf, ami, aq_10, age),"
"0","    by = ""participant.id_in_session"""
"0","  )"
"0",""
"0","# Create alternative dataset with 2:2 grouped in ""with"" condition"
"0","processed_data_alt <- processed_data %>%"
"0","  mutate(consensus_group = case_when("
"0","    consensus_group == ""2:2_against"" ~ ""2:2_with"","
"0","    TRUE ~ as.character(consensus_group)"
"0","  ))"
"0",""
"0","# Scale variables and convert factors"
"0","processed_data <- processed_data %>%"
"0","  mutate("
"0","    across(c(ssms, dass, lsas, srp_sf, ami, aq_10, age), scale),"
"0","    gender = factor(gender),"
"0","    consensus_group = factor(consensus_group, "
"0","                           levels = c(""2:2_against"", ""3:1_against"", ""4:0_against"","
"0","                                    ""3:1_with"", ""4:0_with""))"
"0","  )"
"0",""
"0","processed_data_alt <- processed_data_alt %>%"
"0","  mutate("
"0","    across(c(ssms, dass, lsas, srp_sf, ami, aq_10, age), scale),"
"0","    gender = factor(gender),"
"0","    consensus_group = factor(consensus_group, "
"0","                           levels = c(""3:1_against"", ""4:0_against"","
"0","                                    ""2:2_with"", ""3:1_with"", ""4:0_with""))"
"0","  )"
"0",""
"0","# Enhanced model diagnostics function"
"0","check_model_diagnostics <- function(model) {"
"0","  conv_check <- model@optinfo$conv$opt"
"0","  diagnostics <- list("
"0","    convergence = conv_check,"
"0","    resid_mean = mean(residuals(model)),"
"0","    resid_sd = sd(residuals(model)),"
"0","    resid_normality = shapiro.test(residuals(model))$p.value,"
"0","    outliers = length(boxplot.stats(residuals(model))$out)  # Just count outliers"
"0","  )"
"0","  return(diagnostics)"
"0","}"
"0","# Model running function"
"0","run_questionnaire_models <- function(quest_var) {"
"0","  print(paste(""\nRunning models for:"", quest_var))"
"0","  "
"0","  # Models with 2:2 in against group"
"0","  model1 <- lmer(as.formula(paste(""mean_bet_diff ~ consensus_group *"", quest_var, "
"0","                                 ""+ age + (1|participant.id_in_session)"")),"
"0","                data = processed_data,"
"0","                control = lmerControl(optimizer = ""bobyqa""))"
"0","  "
"0","  model2 <- lmer(as.formula(paste(""mean_bet_diff ~ consensus_group *"", quest_var,"
"0","                                 ""+ age + (1|participant.id_in_session) + (1|gender)"")),"
"0","                data = processed_data,"
"0","                control = lmerControl(optimizer = ""bobyqa""))"
"0","  "
"0","  # Get best model"
"0","  models_list <- list(model1, model2)"
"0","  aic_values <- sapply(models_list, AIC)"
"0","  winning_model <- models_list[[which.min(aic_values)]]"
"0","  "
"0","  # Robustness check with 2:2 in with group"
"0","  alt_model <- lmer(as.formula(paste(""mean_bet_diff ~ consensus_group *"", quest_var, "
"0","                                    ""+ age + (1|participant.id_in_session)"")),"
"0","                   data = processed_data_alt,"
"0","                   control = lmerControl(optimizer = ""bobyqa""))"
"0","  "
"0","  # Get model statistics"
"0","  model_anova <- anova(winning_model)"
"0","  interaction_p <- model_anova[paste0(""consensus_group:"", quest_var), ""Pr(>F)""]"
"0","  "
"0","  alt_anova <- anova(alt_model)"
"0","  alt_p <- alt_anova[paste0(""consensus_group:"", quest_var), ""Pr(>F)""]"
"0","  "
"0","  list("
"0","    questionnaire = quest_var,"
"0","    winning_model = winning_model,"
"0","    p_value = interaction_p,"
"0","    alt_p_value = alt_p,"
"0","    aic = min(aic_values),"
"0","    diagnostics = check_model_diagnostics(winning_model)"
"0","  )"
"0","}"
"0",""
"0","# Custom theme"
"0","theme_custom <- theme_minimal() +"
"0","  theme("
"0","    panel.grid.minor = element_blank(),"
"0","    legend.position = ""right"","
"0","    plot.title = element_text(size = 12, face = ""bold""),"
"0","    plot.subtitle = element_text(size = 10),"
"0","    axis.title = element_text(size = 10),"
"0","    legend.title = element_text(size = 10),"
"0","    legend.text = element_text(size = 9)"
"0","  )"
"0",""
"0","# Plotting function"
"0","plot_continuous_relationship <- function(var, data, model_results) {"
"0","  data <- data %>%"
"0","    mutate("
"0","      consensus_level = case_when("
"0","        str_detect(consensus_group, ""4:0"") ~ ""4:0"","
"0","        str_detect(consensus_group, ""3:1"") ~ ""3:1"","
"0","        str_detect(consensus_group, ""2:2"") ~ ""2:2"""
"0","      ),"
"0","      consensus_level = factor(consensus_level, levels = c(""2:2"", ""3:1"", ""4:0""))"
"0","    )"
"0","  "
"0","  effects <- data %>%"
"0","    group_by(direction, consensus_level) %>%"
"0","    summarise("
"0","      correlation = cor(.data[[var]], mean_bet_diff),"
"0","      .groups = 'drop'"
"0","    )"
"0","  "
"0","  p <- ggplot(data, "
"0","              aes(x = .data[[var]], "
"0","                  y = mean_bet_diff,"
"0","                  color = direction)) +"
"0","    geom_point(alpha = 0.5) +"
"0","    geom_smooth(method = ""lm"", formula = y ~ x) +"
"0","    facet_wrap(~consensus_level) +"
"0","    labs(x = var,"
"0","         y = ""Bet difference (Bet 2 - Bet 1)"","
"0","         title = paste(""Relationship between"", var, ""and bet difference""),"
"0","         subtitle = paste(""Primary analysis p ="", format.pval(model_results$p_value[model_results$questionnaire == var], digits = 3),"
"0","                         ""\nRobustness check p ="", format.pval(model_results$alt_p_value[model_results$questionnaire == var], digits = 3)),"
"0","         caption = paste(""Effect sizes (r) range:"", "
"0","                        round(min(effects$correlation), 3), ""to"","
"0","                        round(max(effects$correlation), 3))) +"
"0","    scale_color_manual(values = c(""Against group"" = ""red"", ""With group"" = ""blue"")) +"
"0","    theme_custom"
"0","  "
"0","  print(p)"
"0","}"
"0",""
"0","# Add the simple slopes analysis function"
"0","analyze_simple_slopes <- function(model, questionnaire_var) {"
"0","  # Create probe points for the questionnaire variable"
"0","  probe_points <- processed_data %>%"
"0","    summarise("
"0","      low = mean(!!sym(questionnaire_var)) - sd(!!sym(questionnaire_var)),"
"0","      mean = mean(!!sym(questionnaire_var)),"
"0","      high = mean(!!sym(questionnaire_var)) + sd(!!sym(questionnaire_var))"
"0","    )"
"0","  "
"0","  # Get predicted values at each probe point"
"0","  pred_data <- expand.grid("
"0","    consensus_group = levels(processed_data$consensus_group),"
"0","    quest_score = c(probe_points$low, probe_points$mean, probe_points$high)"
"0","  ) %>%"
"0","    mutate("
"0","      quest_level = rep(c(""-1 SD"", ""Mean"", ""+1 SD""), "
"0","                       each = length(levels(processed_data$consensus_group)))"
"0","    )"
"0","  "
"0","  # Add other necessary variables at their means/reference levels"
"0","  pred_data$age <- 0  # since age is scaled, 0 is the mean"
"0","  "
"0","  # Create column with questionnaire variable name"
"0","  pred_data[[questionnaire_var]] <- pred_data$quest_score"
"0","  "
"0","  # Get predictions"
"0","  pred_data$predicted <- predict(model, newdata = pred_data, re.form = NA)"
"0","  "
"0","  # Create plot"
"0","  p <- ggplot(pred_data, "
"0","              aes(x = consensus_group, "
"0","                  y = predicted, "
"0","                  color = quest_level, "
"0","                  group = quest_level)) +"
"0","    geom_line() +"
"0","    geom_point(size = 3) +"
"0","    labs(title = paste(""Simple slopes analysis for"", questionnaire_var),"
"0","         x = ""Consensus Group"","
"0","         y = ""Predicted Bet Difference"","
"0","         color = paste(questionnaire_var, ""Level"")) +"
"0","    scale_color_manual(values = c(""red"", ""purple"", ""blue"")) +"
"0","    theme_custom"
"0","  "
"0","  # Get model summary for slopes"
"0","  model_summary <- summary(model)"
"0","  "
"0","  return(list("
"0","    predictions = pred_data,"
"0","    plot = p,"
"0","    model_summary = model_summary"
"0","  ))"
"0","}"
"0",""
"0","# Run analyses"
"0","questionnaire_vars <- c(""ssms"", ""dass"", ""lsas"", ""srp_sf"", ""ami"", ""aq_10"")"
"0","model_results <- map_df(questionnaire_vars, function(var) {"
"0","  result <- run_questionnaire_models(var)"
"0","  tibble("
"0","    questionnaire = result$questionnaire,"
"0","    p_value = result$p_value,"
"0","    alt_p_value = result$alt_p_value,"
"0","    p_adjusted = p.adjust(result$p_value, method = ""fdr""),"
"0","    aic = result$aic,"
"0","    resid_normality = result$diagnostics$resid_normality,"
"0","    model_converged = !is.null(result$diagnostics$convergence)"
"0","  )"
"0","})"
"1","[1]"
"1"," ""\nRunning models for: ssms"""
"1","
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"1","[1]"
"1"," ""\nRunning models for: dass"""
"1","
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"1","[1]"
"1"," ""\nRunning models for: lsas"""
"1","
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"1","[1]"
"1"," ""\nRunning models for: srp_sf"""
"1","
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"1","[1]"
"1"," ""\nRunning models for: ami"""
"1","
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"1","[1]"
"1"," ""\nRunning models for: aq_10"""
"1","
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"2","boundary (singular) fit: see help('isSingular')
"
"0","# Print results"
"0","print(""Model results for each questionnaire:"")"
"1","[1]"
"1"," ""Model results for each questionnaire:"""
"1","
"
"0","print(model_results %>% "
"0","        select(questionnaire, p_value, alt_p_value, p_adjusted) %>%"
"0","        mutate(across(where(is.numeric), ~round(., 3))))"
