---
title: "add_qualtrics_to_otree"
author: "Aamir Sohail"
date: "2025-01-09"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

Only keep relevant data columns:

```{r}
# Read and subset data
data <- read.csv("data/raw/qualtrics/qualtrics.csv")[, c("Finished", "QID10", "QID31",
                paste0("SC", 1:19), "SC21", "SC22", "SC23", "SC24")]

# Set column names from first row and remove top 2 rows
colnames(data) <- as.character(data[1,])
data <- data[-c(1,2),]

# Rename id/age columns  
colnames(data)[2:3] <- c("id", "age")

# Set final column order using original column names
data <- data[, c("Finished", "id", "age", "EDUCATION", "GENDER",
           "LSAS-P", "LSAS-S", "DASS-A", "DASS-D", "DASS-S",
           "SSMS-CD", "SSMS-IA", "SRP-SF-IPM", "SRP-SF-CA", 
           "SRP-SF-ELS", "SRP-SF-CT", "AMI-ES", "AMI-SM", 
           "AMI-BA", "SSMS", "DASS", "LSAS", "SRP-SF", 
           "AMI", "AQ-10", "CHECKS")]

# Now rename education/gender to lowercase
colnames(data)[colnames(data) == "EDUCATION"] <- "education"
colnames(data)[colnames(data) == "GENDER"] <- "gender"

# Save
write.csv(data, "data/preprocessed/qualtrics/qualtrics_subsetted.csv", row.names = FALSE)
```

Generate fake dummy data for remaining Qualtrics participants (ONLY RUN FOR DUMMY ANALYSIS)

```{r}
# Create 8 new rows with exactly matching column names
new_data <- data.frame(
  "Finished" = rep(1, 8),
  "id" = c("65c34e7714a39c42c8e0134e", "6371a9f25c8b47b2b0c43d92g", 
         "65c34e7714a39c42c8e0135f", "6371a9f25c8b47b2b0c43d93h",
         "65c34e7714a39c42c8e0136g", "6371a9f25c8b47b2b0c43d94i",
         "65c34e7714a39c42c8e0137h", "6371a9f25c8b47b2b0c43d95j"),
  "age" = sample(18:45, 8),
  "education" = sample(1:8, 8, replace = TRUE),
  "gender" = sample(1:2, 8, replace = TRUE),
  "LSAS-P" = sample(10:30, 8, replace = TRUE),
  "LSAS-S" = sample(10:30, 8, replace = TRUE),
  "DASS-A" = sample(15:30, 8, replace = TRUE),
  "DASS-D" = sample(15:30, 8, replace = TRUE),
  "DASS-S" = sample(15:30, 8, replace = TRUE),
  "SSMS-CD" = sample(2:10, 8, replace = TRUE),
  "SSMS-IA" = sample(2:10, 8, replace = TRUE),
  "SRP-SF-IPM" = sample(8:15, 8, replace = TRUE),
  "SRP-SF-CA" = sample(8:15, 8, replace = TRUE),
  "SRP-SF-ELS" = sample(8:15, 8, replace = TRUE),
  "SRP-SF-CT" = sample(8:15, 8, replace = TRUE),
  "AMI-ES" = sample(15:25, 8, replace = TRUE),
  "AMI-SM" = sample(15:25, 8, replace = TRUE),
  "AMI-BA" = sample(10:20, 8, replace = TRUE),
  "SSMS" = sample(5:15, 8, replace = TRUE),
  "DASS" = sample(50:80, 8, replace = TRUE),
  "LSAS" = sample(25:45, 8, replace = TRUE),
  "SRP-SF" = sample(30:60, 8, replace = TRUE),
  "AMI" = sample(40:65, 8, replace = TRUE),
  "AQ-10" = sample(1:5, 8, replace = TRUE),
  "CHECKS" = rep(1, 8),
  check.names = FALSE
)

# Combine with existing data
data <- rbind(data, new_data)

write.csv(data, "data/preprocessed/qualtrics/qualtrics_subsetted.csv", row.names = FALSE)
```

Duplicated IDs from Qualtrics to oTree data (just for test analysis)
```{r}
# Load otree data
otree_data <- read.csv("data/preprocessed/otree/subsetted_test_data.csv")

# Create a mapping between id_in_session and the IDs from data
id_mapping <- setNames(data$id, 1:10)

# Replace NAs in participant.label based on id_in_session
otree_data$participant.label <- id_mapping[otree_data$participant.id_in_session]

# Save the updated data
write.csv(otree_data, "data/preprocessed/otree/subsetted_test_data.csv", row.names = FALSE)
```

Add Qualtrics questionnaire data to otree data based on shared Prolific ID and organise properly (subset otree data first)

```{r}
otree_data <- read.csv("data/preprocessed/otree/subsetted_test_data.csv")
qualtrics_data <- read.csv("data/preprocessed/qualtrics/qualtrics_subsetted.csv")

# First, create a copy of qualtrics_data without the CHECKS column
qualtrics_clean <- qualtrics_data[, !colnames(qualtrics_data) %in% "CHECKS"]

# Convert column names to lowercase and replace dots with underscores
colnames(qualtrics_clean) <- tolower(gsub("\\.", "_", colnames(qualtrics_clean)))

# Merge the datasets based on the ID columns
merged_data <- merge(otree_data, 
                    qualtrics_clean,
                    by.x = "participant.label",
                    by.y = "id",
                    all.x = TRUE)

# Sort by trial number and participant id number
merged_data <- merged_data[order(merged_data$subsession.round_number, 
                                      merged_data$participant.id_in_session), ]

# Save
write.csv(merged_data, "data/preprocessed/merged_test_data.csv", row.names = FALSE)
```


